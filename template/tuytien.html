<!DOCTYPE html>
<html>

<head>
    <title></title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }

        .data-raw {
            width: 94%;
            text-align: center;
            background-color: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .img-data-raw {
            width: 94%;
            object-fit: contain;
            margin-bottom: 30px;
            margin-top: 6px;
        }

        .activation {
            width: 94%;
            text-align: center;
            background-color: white;
            border-radius: 10px;
        }

        .image-activation {
            width: 78%;
            object-fit: contain;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .data-and-activation {
            width: 96%;
            display: flex;
            justify-content: space-between;
            flex-direction: row;
        }

        input [type="checkbox"] {
            padding: 8px 10px;
            margin: 8px 0px;
            box-sizing: border-box;
            font-size: 18px;
        }

        label {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 600;
            font-size: 24px;
            color: black;
            margin: 0;
            padding: 0;
            line-height: 50px;
            margin-right: 20px;
        }

        .model {
            width: 94%;
            text-align: center;
            margin-top: 50px;
            background-color: white;
            border-radius: 10px;
            padding-top: 30px;
        }

        .image-model {
            width: 98%;
            object-fit: contain;
            margin-top: 30px;
            margin-bottom: 100px;
        }
    </style>
</head>

<body>
    <h1>Kết quả phân lớp giai đoạn giấc ngủ</h1>
    <!-- <div class="data-and-activation"> -->
    <div class="data-raw">
        <h2>Hình ảnh dữ liệu edf thô</h2>
        {% for file in image_names %}
        {% if file.endswith('Fpz_Cz.png') %}
        <div class="img-chart">
            <img class="img-data-raw" src="{{ url_for('static', filename=file, _external=True) }}" alt="Results">
        </div>
        {% endif %}
        {% endfor %}
    </div>
    <div class="activation">
        <label for="select_activation">Chọn hàm kích hoạt:</label>
        <form name="select_activation" id="select_activation">
            <input type="checkbox" value="relu">ReLU</input>
            <input type="checkbox" value="gelu">GELU</input>
        </form>
        {% for file in image_names %}
        {% if file.endswith('acc.png') %}
        <div class="img-chart">
            <img class="image-activation" src="{{ url_for('static', filename=file, _external=True) }}" alt="Results">
        </div>
        {% endif %}
        {% endfor %}
    </div>

    </div>
    <div class="model">
        {% for file in image_names %}
        {% if file.endswith('true_labels_legend.png') %}
        <div class="img-chart">
            <img class="image-activation" src="{{ url_for('static', filename=file, _external=True) }}" alt="Results">
        </div>
        {% endif %}
        {% endfor %}

        {% for file in image_names %}
        {% if file.endswith('true_line.png') %}
        <div class="img-chart">
            <img class="image-model" src="{{ url_for('static', filename=file, _external=True) }}" alt="Results">
        </div>
        {% endif %}
        {% endfor %}

        <label for="select-model">Chọn mô hình</label>
        <form name="select-model" id="select-model">
            <input type="checkbox" name="model" id="modelAttn" value=1 onchange="updateChart()">AttnSleep</input>
            <input type="checkbox" name="model" id="modelCa-tcc" value=2 onchange="updateChart()">CA-TCC</input>
            <input type="checkbox" name="model" id="modelDeepSleep" value=3 onchange="updateChart()">DeepSleepNet</input>
            <input type="checkbox" name="model" id="modelTs-tcc" value=4 onchange="updateChart()">TS-TCC</input>
            <input type="checkbox" name="model" id="modelTiny" value=5 onchange="updateChart()">TinySleepNet</input>
        </form>

        <canvas id="myChart"></canvas>

        <!-- {% for file in image_names %}
        {% if file.endswith('sum-result.png') %}
        <div class="chart">
            <img class="image-model" src="{{ url_for('static', filename=file, _external=True) }}" alt="Results">
        </div>
        {% endif %}
        {% endfor %} -->
    </div>
</body>

</html>

<script>
    myChart = null
    function updateChart() {
        var selectedValues = [];
        var checkboxes = document.getElementsByName("model");
        var alertMessage = "";

        // Lặp qua các checkbox và lấy giá trị của các checkbox đã được chọn
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                var value = checkboxes[i].value;
                selectedValues.push(value);
                alertMessage += value + "\n";
            }
        }

        // Hiển thị giá trị các checkbox đã chọn trong một thông báo cảnh báo
        console.log("Selected values:\n" + alertMessage);
        // Gửi danh sách giá trị đã chọn đến máy chủ Flask để tạo biểu đồ
        var xhttp = new XMLHttpRequest();

        xhttp.onload = () => {
        // print JSON response
        if (xhttp.status >= 200 && xhttp.status < 300) {
            // parse JSON
            const response = JSON.parse(xhttp.responseText)
            console.log(response)
            drawChart(response)
        }
        }

        xhttp.open("POST", "/update-chart", true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.send(JSON.stringify(selectedValues));
    }
    
    function drawChart(data) {
        var ctx = document.getElementById('myChart').getContext('2d');
        if (!data || Object.keys(data).length === 0) 
        {
            console.error('Invalid data');
            return;
        }

    // Hủy biểu đồ hiện tại nếu đã tồn tại
        if (myChart) {
            myChart.destroy();
        }
        console.log(data.labels)
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.values(data.labels),
                datasets: Object.values(data.data).map(([key, values], index) => ({
                    label: "Motherfucker",
                    data: values,
                    borderColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 1)`,
                    fill: false
                }))
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                    }
                }
            }
        });

        // Kiểm tra nếu biểu đồ đã tồn tại thì hủy nó trước khi vẽ lại
        // if (typeof myChart !== 'undefined') {
        //     myChart.destroy();
        // }
    }

    document.addEventListener("DOMContentLoaded", function(event) {
    // Hàm gửi yêu cầu AJAX để cập nhật dữ liệu biểu đồ
        function updateChart(selectedValues) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var chartData = JSON.parse(this.responseText);
                    drawChart(chartData);
                }
            };

            // Tạo một chuỗi JSON từ các giá trị được chọn
            var requestData = JSON.stringify(selectedValues);

            xhttp.open("POST", "/update-chart", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(requestData);
            
        }

        // Lắng nghe sự kiện onchange cho các phần tử HTML
        var checkboxes = document.querySelectorAll("input[type='checkbox']");
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener("change", function() {
                // Lấy danh sách các giá trị được chọn
                var selectedValues = [];
                checkboxes.forEach(function(checkbox) {
                    if (checkbox.checked) {
                        selectedValues.push(checkbox.value);
                    }
                });
                // Cập nhật dữ liệu biểu đồ
                updateChart(selectedValues);
            });
        });
        updateChart([]);
    });
</script>
